name: ๐ ุชุดุบูู publish.py

on:
  # ุชุดุบูู ูุฏูู ูู ูุงุฌูุฉ GitHub
  workflow_dispatch:
    inputs:
      publish_type:
        description: 'ููุน ุงููุดุฑ'
        required: false
        default: 'draft'
        type: choice
        options:
          - draft
          - publish
      test_mode:
        description: 'ูุถุน ุงูุงุฎุชุจุงุฑ'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.10'

jobs:
  run-publish-script:
    runs-on: ubuntu-latest
    
    steps:
      # ุงูุฎุทูุฉ 1: ุชุญููู ุงูููุฏ
      - name: ๐ฅ ุชุญููู ุงููุณุชูุฏุน
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      # ุงูุฎุทูุฉ 2: ุฅุนุฏุงุฏ Python
      - name: ๐ ุฅุนุฏุงุฏ Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      # ุงูุฎุทูุฉ 3: ุงูุชุญูู ูู ูููู ุงููููุงุช
      - name: ๐ ุงูุชุญูู ูู ุงููููุงุช
        run: |
          echo "๐ ูููู ุงููููุงุช ุงูุญุงูู:"
          find . -type f -name "*.py" -o -name "*.md" -o -name "*.txt" | sort
          echo ""
          
          # ุงูุชุญูู ูู ูุฌูุฏ scripts/publish.py
          if [ ! -f "scripts/publish.py" ]; then
            echo "โ ููู scripts/publish.py ุบูุฑ ููุฌูุฏ!"
            echo "๐ง ุฌุงุฑู ุฅูุดุงุคู..."
            mkdir -p scripts
            # ููุง ุณูุฃุชู ูุญุชูู ุงูููู - ุณููุดุฆู ูุงุญูุงู
          else
            echo "โ scripts/publish.py ููุฌูุฏ"
          fi
          
          # ุฅูุดุงุก ูุฌูุฏ posts ุฅุฐุง ูู ููู ููุฌูุฏุงู
          mkdir -p posts
          mkdir -p published
          
          # ุฅูุดุงุก ููู ุชุฌุฑูุจู ุฅุฐุง ูุงู ุงููุฌูุฏ ูุงุฑุบุงู
          if [ ! -f "posts/ููุงูุฉ-ุชุฌุฑูุจูุฉ.md" ]; then
            cat > posts/ููุงูุฉ-ุชุฌุฑูุจูุฉ.md << 'EOF'
# ุฃูู ููุงูุฉ ุชุฌุฑูุจูุฉ
ูุฐู ููุงูุฉ ุชุฌุฑูุจูุฉ ูููุดุฑ ุงูุชููุงุฆู ุนูู ุจููุฌุฑ.

## ูุญุชูู ุงูููุงูุฉ
- ูุฐู ููุทุฉ ุฃููู
- ููุฐู ููุทุฉ ุซุงููุฉ
- ููุฐู ููุทุฉ ุซุงูุซุฉ

**ููููู ุชุนุฏูู ูุฐุง ุงูููู ุฃู ุฅุถุงูุฉ ูููุงุช .md ุฌุฏูุฏุฉ ูู ูุฌูุฏ posts**
EOF
            echo "โ ุชู ุฅูุดุงุก ููุงูุฉ ุชุฌุฑูุจูุฉ"
          fi
      
      # ุงูุฎุทูุฉ 4: ุฅูุดุงุก ููู publish.py ุฅุฐุง ูู ููู ููุฌูุฏุงู
      - name: ๐ ุฅูุดุงุก publish.py
        if: hashFiles('scripts/publish.py') == ''
        run: |
          echo "๐ง ุฌุงุฑู ุฅูุดุงุก scripts/publish.py..."
          
          cat > scripts/publish.py << 'EOF'
#!/usr/bin/env python3
"""
ุณูุฑูุจุช ุงููุดุฑ ุงูุชููุงุฆู ุนูู ุจููุฌุฑ ูู GitHub Actions
"""

import os
import json
import base64
import pickle
import sys
from datetime import datetime
from pathlib import Path

# ููุชุจุงุช Google API
from google.oauth2.credentials import Credentials
from google.auth.transport.requests import Request
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build
from googleapiclient.errors import HttpError

# ========== ุงูุฅุนุฏุงุฏุงุช ==========
# ูุฐู ุชุฃุชู ูู GitHub Secrets
BLOG_ID = os.environ.get('BLOG_ID', '')
SCOPES = ['https://www.googleapis.com/auth/blogger']

# ========== ุงูุฏูุงู ุงููุณุงุนุฏุฉ ==========
def setup_client_secret():
    """ุฅูุดุงุก ููู client_secret.json ูู ูุชุบูุฑ ุงูุจูุฆุฉ"""
    client_secret_json = os.environ.get('CLIENT_SECRET_JSON')
    
    if not client_secret_json:
        print("โ ุฎุทุฃ: CLIENT_SECRET_JSON ุบูุฑ ููุฌูุฏ ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ")
        print("๐ ุชุฃูุฏ ูู ุฅุถุงูุชู ูู GitHub Secrets")
        print("")
        print("๐ ุฎุทูุงุช ุฅุถุงูุฉ Secrets:")
        print("1. ุงุฐูุจ ุฅูู ูุณุชูุฏุน GitHub โ Settings")
        print("2. Secrets and variables โ Actions")
        print("3. New repository secret")
        print("4. ุงูุงุณู: CLIENT_SECRET_JSON")
        print("5. ุงููููุฉ: ูุญุชูู ููู client_secret.json")
        sys.exit(1)
    
    try:
        # ุชุญูู ูู ุฃู JSON ุตุงูุญ
        json.loads(client_secret_json)
        
        # ูุชุงุจุฉ ุงูููู
        with open('client_secret.json', 'w', encoding='utf-8') as f:
            f.write(client_secret_json)
        
        print("โ ุชู ุฅูุดุงุก client_secret.json")
        return True
    except json.JSONDecodeError as e:
        print(f"โ ุฎุทุฃ ูู ุชูุณูู CLIENT_SECRET_JSON: {e}")
        sys.exit(1)

def get_credentials():
    """ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุงุนุชูุงุฏ (Credentials)"""
    creds = None
    token_b64 = os.environ.get('TOKEN_PICKLE', '')
    
    # 1. ูุญุงููุฉ ุชุญููู token ูู GitHub Secrets
    if token_b64 and token_b64.strip() != '':
        try:
            print("๐ ุชุญููู Token ูู ุงูุจูุฆุฉ...")
            token_data = base64.b64decode(token_b64)
            creds = pickle.loads(token_data)
            print("โ ุชู ุชุญููู Token ูู Secrets")
        except Exception as e:
            print(f"โ๏ธ ูุดู ุชุญููู Token: {e}")
            creds = None
    
    # 2. ุฅุฐุง ูู ููู ููุงู token ุตุงูุญุ ุฅูุดุงุก ุฌุฏูุฏ
    if not creds or not creds.valid:
        print("๐ ุฅูุดุงุก ูุตุงุฏูุฉ ุฌุฏูุฏุฉ...")
        
        if creds and creds.expired and creds.refresh_token:
            print("๐ ุชุฌุฏูุฏ Token...")
            creds.refresh(Request())
        else:
            print("๐ ุฌุงุฑู ูุชุญ ูุงูุฐุฉ ุงููุตุงุฏูุฉ...")
            flow = InstalledAppFlow.from_client_secrets_file(
                'client_secret.json', 
                SCOPES
            )
            creds = flow.run_local_server(port=0)
        
        # ุญูุธ Token ุงูุฌุฏูุฏ ูู Base64
        token_pickle = pickle.dumps(creds)
        token_b64_new = base64.b64encode(token_pickle).decode('utf-8')
        
        print("\n" + "="*70)
        print("๐จ **ููู: ุงูุณุฎ ูุฐุง ุงูู Token ูุฃุถูู ูู GitHub Secrets**")
        print("="*70)
        print("ุงูุงุณู: TOKEN_PICKLE")
        print("ุงููููุฉ (ุงูุฌุฒุก ุงูุฃูู):")
        print(f"{token_b64_new[:100]}...")
        print("")
        print("๐ ุฎุทูุงุช ุฅุถุงูุฉ Token:")
        print("1. ุงุฐูุจ ุฅูู GitHub โ Settings โ Secrets โ Actions")
        print("2. New repository secret")
        print("3. Name: TOKEN_PICKLE")
        print("4. Value: ุงูุตู ุงูู Token ุงููุงูู (ุงูุฐู ูุธูุฑ ูู ุงููlogs)")
        print("5. Add secret")
        print("6. ุดุบู Workflow ูุฑุฉ ุฃุฎุฑู")
        print("="*70)
        
        # ุฅุฎุฑุงุฌ Token ูุงูู ููุณุฌู
        with open('token_full.txt', 'w') as f:
            f.write(token_b64_new)
        
        # ูููู ุงูุนูููุฉ ููุง ูุฃุฎุฐ ุงููToken
        print("\n๐ ุชููู ุงูุนูููุฉ ูุฅุถุงูุฉ ุงููToken")
        sys.exit(0)
    
    return creds

def publish_post(service, title, content, labels=None, draft=True):
    """ูุดุฑ ููุงู ุนูู ุจููุฌุฑ"""
    try:
        post_body = {
            'title': title,
            'content': content,
            'labels': labels or ['github-auto', 'auto-publish'],
        }
        
        print(f"๐ ุฌุงุฑู ูุดุฑ: {title}")
        
        # ุฅุฑุณุงู ุงูููุดูุฑ
        request = service.posts().insert(
            blogId=BLOG_ID,
            body=post_body,
            isDraft=draft
        )
        post = request.execute()
        
        status = "ูุณูุฏุฉ" if draft else "ููุดูุฑ"
        print(f"โ ุชู ุงููุดุฑ ุจูุฌุงุญ ูู {status}!")
        if not draft and 'url' in post:
            print(f"๐ ุงูุฑุงุจุท: {post['url']}")
        
        return post
        
    except HttpError as error:
        print(f"โ ุฎุทุฃ ูู ุงููุดุฑ: {error}")
        return None
    except Exception as e:
        print(f"โ ุฎุทุฃ ุบูุฑ ูุชููุน: {e}")
        return None

def read_posts_from_folder(folder_path='posts'):
    """ูุฑุงุกุฉ ุงูููุงูุงุช ูู ูุฌูุฏ posts"""
    posts = []
    
    posts_dir = Path(folder_path)
    
    if not posts_dir.exists():
        print(f"โ๏ธ ูุฌูุฏ '{folder_path}' ุบูุฑ ููุฌูุฏ")
        return posts
    
    # ูุฑุงุกุฉ ุฌููุน ูููุงุช .md
    for md_file in posts_dir.glob('*.md'):
        try:
            with open(md_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # ุงุณุชุฎุฑุงุฌ ุงูุนููุงู ูู ุฃูู ุณุทุฑ (ูุจุฏุฃ ุจู #)
            lines = content.strip().split('\n')
            title = 'ููุงู ุจุฏูู ุนููุงู'
            
            if lines and lines[0].startswith('#'):
                title = lines[0].replace('#', '').strip()
                body_content = '\n'.join(lines[1:])
            else:
                title = md_file.stem.replace('-', ' ').title()
                body_content = content
            
            posts.append({
                'file': md_file.name,
                'title': title,
                'content': body_content,
                'html_content': f"<h1>{title}</h1>\n<p>" + 
                               body_content.replace('\n', '</p>\n<p>') + "</p>"
            })
            
            print(f"๐ ูุฌุฏุช ููุงูุฉ: {title}")
            
        except Exception as e:
            print(f"โ๏ธ ุฎุทุฃ ูู ูุฑุงุกุฉ {md_file}: {e}")
    
    return posts

# ========== ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ==========
def main():
    print("="*60)
    print("๐ ุจุฏุก ุนูููุฉ ุงููุดุฑ ุงูุชููุงุฆู ุนูู ุจููุฌุฑ")
    print("="*60)
    
    # ุงูุชุญูู ูู BLOG_ID
    if not BLOG_ID:
        print("โ BLOG_ID ุบูุฑ ูุญุฏุฏ")
        print("๐ ุฃุถูู ูู GitHub Secrets โ BLOG_ID")
        sys.exit(1)
    
    print(f"๐ Blog ID: {BLOG_ID}")
    print(f"๐ ุงูููุช: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("-" * 60)
    
    # 1. ุฅุนุฏุงุฏ ููู client_secret.json
    if not setup_client_secret():
        return
    
    # 2. ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุงุนุชูุงุฏ
    creds = get_credentials()
    if not creds:
        print("โ ูุดู ูู ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุงุนุชูุงุฏ")
        return
    
    # 3. ุงูุงุชุตุงู ุจุฎุฏูุฉ ุจููุฌุฑ
    try:
        service = build('blogger', 'v3', credentials=creds)
        print("โ ุชู ุงูุงุชุตุงู ุจุฎุฏูุฉ ุจููุฌุฑ ุจูุฌุงุญ")
    except Exception as e:
        print(f"โ ูุดู ุงูุงุชุตุงู ุจุจููุฌุฑ: {e}")
        return
    
    # 4. ูุฑุงุกุฉ ุงูููุงูุงุช ูู ูุฌูุฏ posts
    posts = read_posts_from_folder('posts')
    
    if not posts:
        print("๐ญ ูุง ุชูุฌุฏ ููุงูุงุช ูู ูุฌูุฏ posts")
        
        # ูุดุฑ ููุงู ุชุฌุฑูุจู ุฅุฐุง ูู ุชูุฌุฏ ููุงูุงุช
        print("\n๐ง ูุดุฑ ููุงู ุชุฌุฑูุจู...")
        test_post = {
            'title': f'ุงุฎุชุจุงุฑ ุชููุงุฆู - {datetime.now().strftime("%Y-%m-%d %H:%M")}',
            'content': '''
            <h2>๐ ูุฌุงุญ!</h2>
            <p>ุชู ุงููุดุฑ ุชููุงุฆูุงู ุนุจุฑ GitHub Actions</p>
            <p>ุงูุชุงุฑูุฎ: {}</p>
            <p>ููููู ุฅุถุงูุฉ ูููุงุช .md ูู ูุฌูุฏ <code>posts</code></p>
            <ul>
                <li>ุงูููุทุฉ ุงูุฃููู</li>
                <li>ุงูููุทุฉ ุงูุซุงููุฉ</li>
                <li>ุงูููุทุฉ ุงูุซุงูุซุฉ</li>
            </ul>
            '''.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
        }
        
        publish_type = os.environ.get('PUBLISH_TYPE', 'draft')
        is_draft = publish_type.lower() == 'draft'
        
        result = publish_post(
            service=service,
            title=test_post['title'],
            content=test_post['content'],
            labels=['ุงุฎุชุจุงุฑ', 'github-actions', 'ุฃููู'],
            draft=is_draft
        )
        
        if result:
            print("โ ุชู ูุดุฑ ุงูููุงูุฉ ุงูุชุฌุฑูุจูุฉ")
    else:
        # 5. ูุดุฑ ูู ุงูููุงูุงุช
        print(f"\n๐ค ุฌุงุฑู ูุดุฑ {len(posts)} ููุงูุฉ...")
        
        publish_type = os.environ.get('PUBLISH_TYPE', 'draft')
        is_draft = publish_type.lower() == 'draft'
        published_count = 0
        
        for post in posts:
            result = publish_post(
                service=service,
                title=post['title'],
                content=post['html_content'],
                labels=['auto-published', 'github'],
                draft=is_draft
            )
            
            if result:
                published_count += 1
        
        print(f"\n๐ ุงููุชูุฌุฉ: ููุดุฑ {published_count} ูู ุฃุตู {len(posts)} ููุงูุฉ")
    
    print("\n" + "="*60)
    print("๐ ุงูุชููุช ุงูุนูููุฉ ุจูุฌุงุญ!")
    print("="*60)

# ========== ููุทุฉ ุงูุฏุฎูู ==========
if __name__ == '__main__':
    main()
EOF
          
          echo "โ ุชู ุฅูุดุงุก scripts/publish.py"
      
      # ุงูุฎุทูุฉ 5: ุชุซุจูุช ุงููุชุทูุจุงุช
      - name: ๐ฆ ุชุซุจูุช ุงูููุชุจุงุช ุงููุทููุจุฉ
        run: |
          # ุฅูุดุงุก requirements.txt ุฅุฐุง ูู ููู ููุฌูุฏุงู
          if [ ! -f "requirements.txt" ]; then
            cat > requirements.txt << 'EOF'
          google-api-python-client
          google-auth-httplib2
          google-auth-oauthlib
          EOF
          fi
          
          echo "๐ฆ ุชุซุจูุช ุงูููุชุจุงุช ูู requirements.txt..."
          pip install -r requirements.txt
      
      # ุงูุฎุทูุฉ 6: ุชุดุบูู ุงูุณูุฑูุจุช
      - name: ๐ ุชุดุบูู publish.py
        env:
          # **** ุงููุชุบูุฑุงุช ุงูุณุฑูุฉ ****
          BLOG_ID: ${{ secrets.BLOG_ID }}
          CLIENT_SECRET_JSON: ${{ secrets.CLIENT_SECRET_JSON }}
          TOKEN_PICKLE: ${{ secrets.TOKEN_PICKLE }}
          PUBLISH_TYPE: ${{ inputs.publish_type }}
        run: |
          echo "โ๏ธ  ุฅุนุฏุงุฏุงุช ุงูุชุดุบูู:"
          echo "   ููุน ุงููุดุฑ: $PUBLISH_TYPE"
          echo "   BLOG_ID: ${{ secrets.BLOG_ID != '' && 'โ ููุฌูุฏ' || 'โ ููููุฏ' }}"
          echo "   CLIENT_SECRET_JSON: ${{ secrets.CLIENT_SECRET_JSON != '' && 'โ ููุฌูุฏ' || 'โ ููููุฏ' }}"
          echo "   TOKEN_PICKLE: ${{ secrets.TOKEN_PICKLE != '' && 'โ ููุฌูุฏ' || 'โ ููููุฏ' }}"
          echo ""
          
          # ุงูุชุญูู ูู ูุฌูุฏ ุงููุชุบูุฑุงุช ุงููุทููุจุฉ
          if [ -z "${{ secrets.BLOG_ID }}" ]; then
            echo "โ BLOG_ID ุบูุฑ ููุฌูุฏ ูู Secrets"
            echo ""
            echo "๐ ููููุฉ ุฅุถุงูุชู:"
            echo "1. ุงุฐูุจ ุฅูู ูุฏููุชู ุนูู blogger.com"
            echo "2. ุงูุธุฑ ุฅูู ุงูุฑูู ูู ุงูุฑุงุจุท: .../edit/1234567890123456789/..."
            echo "3. ูุฐุง ุงูุฑูู ูู BLOG_ID"
            echo "4. ุฃุถูู ูู GitHub Secrets โ BLOG_ID"
            exit 1
          fi
          
          if [ -z "${{ secrets.CLIENT_SECRET_JSON }}" ]; then
            echo "โ CLIENT_SECRET_JSON ุบูุฑ ููุฌูุฏ"
            echo ""
            echo "๐ ููููุฉ ุงูุญุตูู ุนููู:"
            echo "1. ุงุฐูุจ ุฅูู https://console.cloud.google.com/"
            echo "2. ุฃูุดุฆ ูุดุฑูุน ุฌุฏูุฏ"
            echo "3. ุชูุนูู Blogger API"
            echo "4. Create Credentials โ OAuth client ID โ Desktop App"
            echo "5. ุงูุณุฎ ุงูู Client ID ู Client Secret"
            echo "6. ุฃูุดุฆ ููู client_secret.json ุจูุฐุง ุงููุญุชูู:"
            echo '{"installed":{"client_id":"YOUR_CLIENT_ID","client_secret":"YOUR_CLIENT_SECRET","redirect_uris":["http://localhost"]}}'
            echo "7. ุฃุถู ุงููุญุชูู ูุงููุงู ูู GitHub Secrets โ CLIENT_SECRET_JSON"
            exit 1
          fi
          
          echo "โถ๏ธ  ุชุดุบูู ุงูุณูุฑูุจุช..."
          cd scripts
          python publish.py
      
      # ุงูุฎุทูุฉ 7: ุนุฑุถ ุงููุชูุฌุฉ
      - name: ๐ ูุชูุฌุฉ ุงูุชูููุฐ
        if: always()
        run: |
          echo ""
          echo "="*60
          echo "              ๐ ุชูุฑูุฑ ุงูุชูููุฐ"
          echo "="*60
          echo "ุงููุชูุฌุฉ: ${{ job.status }}"
          echo "ุงูููุช: $(date)"
          
          # ุนุฑุถ ุงููููุงุช ุงูููุฌูุฏุฉ
          echo ""
          echo "๐ ุงููููุงุช ูู posts:"
          ls -la posts/ 2>/dev/null || echo "ุงููุฌูุฏ ูุงุฑุบ"
          
          echo ""
          echo "๐ ุงููููุงุช ูู published:"
          ls -la published/ 2>/dev/null || echo "ุงููุฌูุฏ ูุงุฑุบ"
          
          echo ""
          if [ "${{ job.status }}" == "success" ]; then
            echo "โ ุงูุนูููุฉ ุงูุชููุช ุจูุฌุงุญ!"
            echo "๐ ุชุญูู ูู ูุฏููุชู ุนูู blogger.com"
          else
            echo "โ๏ธ  ููุงู ูุดููุฉ ูู ุงูุชูููุฐ"
            echo "๐ ุฑุงุฌุน ุงููlogs ุฃุนูุงู ููุชูุงุตูู"
          fi
          echo "="*60
