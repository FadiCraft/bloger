name: ๐ ูุดุฑ ุจููุฌุฑ ุฃูุชููุงุชูู

on:
  workflow_dispatch:
    inputs:
      publish_type:
        description: 'ููุน ุงููุดุฑ'
        required: false
        default: 'draft'
        type: choice
        options:
          - draft
          - publish

jobs:
  publish-to-blogger:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ุชุญููู ุงูููุฏ
      - name: โฌ๏ธ ุชุญููู ุงููุณุชูุฏุน
        uses: actions/checkout@v3
      
      # 2. ุฅุนุฏุงุฏ Python
      - name: ๐ ุฅุนุฏุงุฏ Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # 3. ุฅูุดุงุก ูููู ุงููููุงุช
      - name: ๐ ุฅูุดุงุก ุงููููู
        run: |
          mkdir -p scripts
          mkdir -p posts
          mkdir -p published
      
      # 4. ุฅูุดุงุก ุณูุฑูุจุช ุงููุดุฑ
      - name: ๐ ุฅูุดุงุก publish.py
        run: |
          cat > scripts/publish.py << 'EOF'
import os, json, base64, pickle, sys
from datetime import datetime

try:
    from google.oauth2.credentials import Credentials
    from google.auth.transport.requests import Request
    from google_auth_oauthlib.flow import InstalledAppFlow
    from googleapiclient.discovery import build
except ImportError:
    print("โ ุงูููุชุจุงุช ุบูุฑ ูุซุจุชุฉ")
    sys.exit(1)

# ุฅุนุฏุงุฏุงุช
BLOG_ID = os.environ.get('BLOG_ID')
CLIENT_SECRET_JSON = os.environ.get('CLIENT_SECRET_JSON')
TOKEN_PICKLE = os.environ.get('TOKEN_PICKLE', '')
PUBLISH_TYPE = os.environ.get('PUBLISH_TYPE', 'draft')

def main():
    print("="*60)
    print("๐ ูุดุฑ ุชููุงุฆู ุนูู ุจููุฌุฑ")
    print("="*60)
    
    # ุงูุชุญูู ูู ุงูุจูุงูุงุช
    if not BLOG_ID:
        print("โ BLOG_ID ุบูุฑ ููุฌูุฏ")
        return
    
    if not CLIENT_SECRET_JSON:
        print("โ CLIENT_SECRET_JSON ุบูุฑ ููุฌูุฏ")
        return
    
    # 1. ุฅูุดุงุก client_secret.json
    try:
        with open('client_secret.json', 'w') as f:
            f.write(CLIENT_SECRET_JSON)
        print("โ ุชู ุฅูุดุงุก client_secret.json")
    except Exception as e:
        print(f"โ ุฎุทุฃ: {e}")
        return
    
    # 2. ุงููุตุงุฏูุฉ
    creds = None
    SCOPES = ['https://www.googleapis.com/auth/blogger']
    
    if TOKEN_PICKLE and TOKEN_PICKLE.strip():
        try:
            token_data = base64.b64decode(TOKEN_PICKLE)
            creds = pickle.loads(token_data)
            print("โ ุชู ุชุญููู Token")
        except:
            print("โ๏ธ Token ุบูุฑ ุตุงูุญ")
            creds = None
    
    if not creds or not creds.valid:
        print("๐ ุฌุงุฑู ุงููุตุงุฏูุฉ...")
        try:
            flow = InstalledAppFlow.from_client_secrets_file('client_secret.json', SCOPES)
            creds = flow.run_local_server(port=0)
            
            # ุญูุธ Token ุงูุฌุฏูุฏ
            new_token = base64.b64encode(pickle.dumps(creds)).decode()
            print("\n" + "="*60)
            print("๐ซ **ุงูุณุฎ ูุฐุง ุงููToken:**")
            print("="*60)
            print(new_token)
            print("="*60)
            print("\n๐ ุฃุถูู ูู GitHub Secrets โ TOKEN_PICKLE")
            return
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ุงููุตุงุฏูุฉ: {e}")
            return
    
    # 3. ุงููุดุฑ
    try:
        service = build('blogger', 'v3', credentials=creds)
        
        title = f"ุงุฎุชุจุงุฑ ูู GitHub - {datetime.now().strftime('%Y-%m-%d %H:%M')}"
        content = f'''
        <h1>๐ ูุฌุงุญ!</h1>
        <p>ุชู ุงููุดุฑ ุชููุงุฆูุงู ุนุจุฑ GitHub Actions</p>
        <p>ุงูุชุงุฑูุฎ: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
        <p>ููุน ุงููุดุฑ: {'ูุณูุฏุฉ' if PUBLISH_TYPE == 'draft' else 'ููุดูุฑ'}</p>
        '''
        
        is_draft = PUBLISH_TYPE == 'draft'
        
        post = service.posts().insert(
            blogId=BLOG_ID,
            body={'title': title, 'content': content, 'labels': ['github', 'auto']},
            isDraft=is_draft
        ).execute()
        
        print(f"\nโ ุชู ุงููุดุฑ ุจูุฌุงุญ!")
        print(f"๐ ุงูุนููุงู: {title}")
        print(f"๐ ุงูุญุงูุฉ: {'ูุณูุฏุฉ' if is_draft else 'ููุดูุฑ'}")
        
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ุงููุดุฑ: {e}")

if __name__ == '__main__':
    main()
EOF
          echo "โ ุชู ุฅูุดุงุก scripts/publish.py"
      
      # 5. ุชุซุจูุช ุงูููุชุจุงุช
      - name: ๐ฆ ุชุซุจูุช ุงูููุชุจุงุช
        run: pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
      
      # 6. ุชุดุบูู ุงูุณูุฑูุจุช
      - name: ๐ ุชุดุบูู ุงููุดุฑ
        env:
          BLOG_ID: ${{ secrets.BLOG_ID }}
          CLIENT_SECRET_JSON: ${{ secrets.CLIENT_SECRET_JSON }}
          TOKEN_PICKLE: ${{ secrets.TOKEN_PICKLE }}
          PUBLISH_TYPE: ${{ inputs.publish_type }}
        run: |
          echo "๐ง ุฌุงุฑู ุงูุชุดุบูู..."
          echo "๐ ููุน ุงููุดุฑ: $PUBLISH_TYPE"
          python scripts/publish.py
      
      # 7. ูุชูุฌุฉ ุงูุนูููุฉ
      - name: ๐ ุงููุชูุฌุฉ
        if: always()
        run: |
          echo ""
          echo "="*60
          echo "              ๐ ุชูุฑูุฑ ุงูุชูููุฐ"
          echo "="*60
          echo "โ ุงูุนูููุฉ ุงูุชููุช"
          echo "๐ ุงูููุช: $(date)"
          echo ""
          echo "๐ **ููุงุญุธุงุช:**"
          echo "1. ุฅุฐุง ุธูุฑ Tokenุ ุงูุณุฎู ูุฃุถูู ูู Secrets โ TOKEN_PICKLE"
          echo "2. ุฅุฐุง ูุฌุญ ุงููุดุฑุ ุชุญูู ูู ูุฏููุชู ุนูู blogger.com"
          echo "3. ุฌุฑุจ ุชุบููุฑ ููุน ุงููุดุฑ ุฅูู 'publish' ูููุดุฑ ุงููุจุงุดุฑ"
          echo "="*60
