name: ğŸ¯ Ù†Ø´Ø± Ø¨Ù„ÙˆØ¬Ø± ÙƒØ§Ù…Ù„

on:
  workflow_dispatch:
    inputs:
      publish_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø±'
        required: false
        default: 'draft'
        type: choice
        options:
          - draft
          - publish

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    # === Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ø¶ÙŠØ± ===
    - name: â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: ğŸ Ø¥Ø¹Ø¯Ø§Ø¯ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    # === Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ===
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      run: |
        pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
    
    # === Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª ===
    - name: ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‡ÙŠÙƒÙ„
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª
        mkdir -p posts
        mkdir -p scripts
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù‚Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        cat > posts/Ù…Ù‚Ø§Ù„Ø©-ØªØ¬Ø±ÙŠØ¨ÙŠØ©.md << 'EOF'
# Ø£ÙˆÙ„ Ù…Ù‚Ø§Ù„Ø© Ù…Ù† GitHub
Ù‡Ø°Ù‡ Ù…Ù‚Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© ØªÙ†Ø´Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.

## Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø§Ù„Ø©:
- Ù†Ù‚Ø·Ø© Ø£ÙˆÙ„Ù‰
- Ù†Ù‚Ø·Ø© Ø«Ø§Ù†ÙŠØ©
- Ù†Ù‚Ø·Ø© Ø«Ø§Ù„Ø«Ø©

**Ù…Ø¨Ø±ÙˆÙƒ! Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„.**
EOF
        
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‚Ø§Ù„Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©"
    
    # === Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ù†Ø´Ø± ===
    - name: ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ publish.py
      run: |
        cat > scripts/publish.py << 'EOF'
import os, json, base64, pickle, sys
from datetime import datetime

print("="*60)
print("ğŸš€ Ø¨Ø¯Ø¡ Ù†Ø´Ø± Ø¨Ù„ÙˆØ¬Ø±")
print("="*60)

# Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
BLOG_ID = os.environ.get('BLOG_ID')
CLIENT_SECRET_JSON = os.environ.get('CLIENT_SECRET_JSON')
TOKEN_PICKLE = os.environ.get('TOKEN_PICKLE', '')
PUBLISH_TYPE = os.environ.get('PUBLISH_TYPE', 'draft')

print(f"ğŸ“Œ BLOG_ID: {'âœ… Ù…ÙˆØ¬ÙˆØ¯' if BLOG_ID else 'âŒ Ù…ÙÙ‚ÙˆØ¯'}")
print(f"ğŸ“Œ CLIENT_SECRET_JSON: {'âœ… Ù…ÙˆØ¬ÙˆØ¯' if CLIENT_SECRET_JSON else 'âŒ Ù…ÙÙ‚ÙˆØ¯'}")
print(f"ğŸ“Œ TOKEN_PICKLE: {'âœ… Ù…ÙˆØ¬ÙˆØ¯' if TOKEN_PICKLE else 'âŒ Ù…ÙÙ‚ÙˆØ¯'}")
print(f"ğŸ“Œ Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø±: {PUBLISH_TYPE}")
print("-"*60)

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
if not BLOG_ID:
    print("âŒ BLOG_ID ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
    sys.exit(1)

if not CLIENT_SECRET_JSON:
    print("âŒ CLIENT_SECRET_JSON ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
    sys.exit(1)

# 1. Ø¥Ù†Ø´Ø§Ø¡ client_secret.json
try:
    with open('client_secret.json', 'w') as f:
        f.write(CLIENT_SECRET_JSON)
    print("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ client_secret.json")
except Exception as e:
    print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ client_secret.json: {e}")
    sys.exit(1)

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Google
try:
    from google.oauth2.credentials import Credentials
    from google.auth.transport.requests import Request
    from google_auth_oauthlib.flow import InstalledAppFlow
    from googleapiclient.discovery import build
except ImportError as e:
    print(f"âŒ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª ØºÙŠØ± Ù…Ø«Ø¨ØªØ©: {e}")
    sys.exit(1)

# 2. Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
creds = None
SCOPES = ['https://www.googleapis.com/auth/blogger']

if TOKEN_PICKLE and TOKEN_PICKLE.strip():
    try:
        print("ğŸ”‘ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Token...")
        token_data = base64.b64decode(TOKEN_PICKLE)
        creds = pickle.loads(token_data)
        print("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Token Ù…Ù† Secrets")
    except Exception as e:
        print(f"âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Token: {e}")
        creds = None
else:
    print("ğŸ“­ Ù„Ø§ ÙŠÙˆØ¬Ø¯ TokenØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯...")

if not creds or not creds.valid:
    print("ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Google...")
    try:
        flow = InstalledAppFlow.from_client_secrets_file('client_secret.json', SCOPES)
        creds = flow.run_local_server(port=0)
        
        # ØªÙˆÙ„ÙŠØ¯ Token Ø¬Ø¯ÙŠØ¯
        token_pickle = pickle.dumps(creds)
        token_b64 = base64.b64encode(token_pickle).decode('utf-8')
        
        print("\n" + "="*70)
        print("ğŸ« **Ù…Ù‡Ù…: Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ù€Token ÙˆØ£Ø¶ÙÙ‡ ÙÙŠ GitHub Secrets**")
        print("="*70)
        print("Ø§Ø³Ù… Ø§Ù„Ù€Secret: TOKEN_PICKLE")
        print("Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„):")
        print(token_b64[:100] + "...")
        print("="*70)
        print("\nğŸ“‹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:")
        print("1. Settings â†’ Secrets â†’ Actions")
        print("2. New repository secret")
        print("3. Name: TOKEN_PICKLE")
        print("4. Value: Ø§Ù„ØµÙ‚ Ø§Ù„Ù€Token Ø§Ù„ÙƒØ§Ù…Ù„")
        print("5. Add secret")
        print("6. Ø´ØºÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù€workflow Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")
        print("="*70)
        
        # Ø­ÙØ¸ Token ÙÙŠ Ù…Ù„Ù Ù„Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„ÙŠÙ‡
        with open('token_output.txt', 'w') as f:
            f.write(token_b64)
        
        print("\nğŸ›‘ ØªÙˆÙ‚Ù: Ø£Ø¶Ù Ø§Ù„Ù€Token Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø´ØºÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰")
        sys.exit(0)
        
    except Exception as e:
        print(f"âŒ ÙØ´Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: {e}")
        sys.exit(1)

# 3. Ø§Ù„Ù†Ø´Ø±
try:
    print("\nğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¨Ù„ÙˆØ¬Ø±...")
    service = build('blogger', 'v3', credentials=creds)
    
    # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
    articles = []
    if os.path.exists('posts'):
        for file in os.listdir('posts'):
            if file.endswith('.md'):
                with open(f'posts/{file}', 'r', encoding='utf-8') as f:
                    content = f.read()
                
                # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                lines = content.split('\n')
                title = lines[0].replace('#', '').strip() if lines else file
                body = '\n'.join(lines[1:]) if len(lines) > 1 else content
                
                articles.append({
                    'title': title,
                    'content': f"<h1>{title}</h1>\n<p>{body.replace(chr(10), '</p><p>')}</p>"
                })
    
    if not articles:
        # Ù…Ù‚Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        title = f"Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† GitHub - {datetime.now().strftime('%Y-%m-%d %H:%M')}"
        content = f'''
        <h1>ğŸ‰ ØªÙ… Ø§Ù„Ù†Ø´Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!</h1>
        <p>Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</p>
        <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
        <p>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø±: {'Ù…Ø³ÙˆØ¯Ø©' if PUBLISH_TYPE == 'draft' else 'Ù…Ù†Ø´ÙˆØ± Ù…Ø¨Ø§Ø´Ø±'}</p>
        '''
        articles = [{'title': title, 'content': content}]
    
    # Ù†Ø´Ø± ÙƒÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
    is_draft = PUBLISH_TYPE == 'draft'
    published_count = 0
    
    for article in articles:
        print(f"\nğŸ“ Ø¬Ø§Ø±ÙŠ Ù†Ø´Ø±: {article['title']}")
        
        post_body = {
            'title': article['title'],
            'content': article['content'],
            'labels': ['github-actions', 'auto-publish']
        }
        
        try:
            post = service.posts().insert(
                blogId=BLOG_ID,
                body=post_body,
                isDraft=is_draft
            ).execute()
            
            published_count += 1
            status = "Ù…Ø³ÙˆØ¯Ø©" if is_draft else "Ù…Ù†Ø´ÙˆØ±"
            print(f"âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± ÙƒÙ€ {status}")
            
            if not is_draft and 'url' in post:
                print(f"ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·: {post['url']}")
                
        except Exception as e:
            print(f"âŒ ÙØ´Ù„ Ù†Ø´Ø± Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‚Ø§Ù„Ø©: {e}")
    
    print(f"\nğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ù†ÙØ´Ø± {published_count} Ù…Ù‚Ø§Ù„Ø©")
    
except Exception as e:
    print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø´Ø±: {e}")
    sys.exit(1)

print("\n" + "="*60)
print("ğŸ‰ Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!")
print("="*60)
EOF
        echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ù†Ø´Ø±"
    
    # === Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§Ù„ØªØ´ØºÙŠÙ„ ===
    - name: ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø´Ø±
      env:
        BLOG_ID: ${{ secrets.BLOG_ID }}
        CLIENT_SECRET_JSON: ${{ secrets.CLIENT_SECRET_JSON }}
        TOKEN_PICKLE: ${{ secrets.TOKEN_PICKLE }}
        PUBLISH_TYPE: ${{ inputs.publish_type }}
      run: |
        echo "ğŸ”§ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„..."
        echo "ğŸ“Œ Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø±: $PUBLISH_TYPE"
        python scripts/publish.py
    
    # === Ø§Ù„Ø®Ø·ÙˆØ© 6: Ù†ØªÙŠØ¬Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© ===
    - name: ğŸ“‹ Ø§Ù„Ù†ØªÙŠØ¬Ø©
      if: always()
      run: |
        echo ""
        echo "="*60
        echo "              ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ"
        echo "="*60
        echo "ğŸ•’ Ø§Ù„ÙˆÙ‚Øª: $(date)"
        echo "ğŸ“Œ BLOG_ID: ${{ secrets.BLOG_ID != '' && 'âœ… Ù…ÙˆØ¬ÙˆØ¯' || 'âŒ Ù…ÙÙ‚ÙˆØ¯' }}"
        echo "ğŸ“Œ CLIENT_SECRET_JSON: ${{ secrets.CLIENT_SECRET_JSON != '' && 'âœ… Ù…ÙˆØ¬ÙˆØ¯' || 'âŒ Ù…ÙÙ‚ÙˆØ¯' }}"
        echo "ğŸ“Œ TOKEN_PICKLE: ${{ secrets.TOKEN_PICKLE != '' && 'âœ… Ù…ÙˆØ¬ÙˆØ¯' || 'âŒ Ù…ÙÙ‚ÙˆØ¯' }}"
        echo ""
        
        if [ -f "token_output.txt" ]; then
          echo "âš ï¸  ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Token Ø¬Ø¯ÙŠØ¯"
          echo "ğŸ“‹ Ø£Ø¶ÙÙ‡ ÙÙŠ GitHub Secrets â†’ TOKEN_PICKLE"
        fi
        
        echo ""
        echo "ğŸ” ØªØ­Ù‚Ù‚ Ù…Ù†:"
        echo "1. blogger.com â†’ Ù…Ø¯ÙˆÙ†ØªÙƒ â†’ Ù…Ø³ÙˆØ¯Ø§Øª"
        echo "2. Ø£Ùˆ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª publish"
        echo "="*60
